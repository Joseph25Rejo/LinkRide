<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Spotify Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        :root {
            --spotify-green: #1DB954;
            --dark-bg: #121212;
            --card-bg: #181818;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --hover-bg: #282828;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Circular', Arial, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(45deg, #1DB954, #191414);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            gap: 20px;
        }

        .login-logo {
            width: 200px;
            margin-bottom: 30px;
        }

        .login-button {
            background: white;
            color: black;
            padding: 15px 30px;
            border-radius: 25px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .login-button:hover {
            transform: scale(1.05);
            background: var(--text-primary);
        }

        /* Sidebar */
        .sidebar {
            background: black;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .logo {
            padding: 10px 0;
            border-bottom: 1px solid #282828;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 5px;
            gap: 15px;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }

        .nav-item.active {
            color: var(--spotify-green);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .content-header {
            position: sticky;
            top: 0;
            background: var(--dark-bg);
            padding: 20px 0;
            z-index: 2;
        }

        /* Search */
        .search-bar {
            position: relative;
            margin-bottom: 30px;
            max-width: 600px;
        }

        .search-input {
            width: 100%;
            padding: 15px 45px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 16px;
            transition: var(--transition);
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Music Grid */
        .section-title {
            margin: 30px 0 20px;
            font-size: 24px;
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 100px;
        }

        .track-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .track-card:hover {
            background: var(--hover-bg);
        }

        .track-card:hover .play-overlay {
            opacity: 1;
            transform: translateY(0);
        }

        .track-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            margin-bottom: 15px;
            object-fit: cover;
        }

        .track-title {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            color: var(--text-secondary);
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-overlay {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 40px;
            height: 40px;
            background: var(--spotify-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(10px);
            transition: var(--transition);
        }

        /* Queue Panel */
        .queue-panel {
            background: var(--card-bg);
            padding: 20px;
            border-left: 1px solid #282828;
            overflow-y: auto;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .queue-item:hover {
            background: var(--hover-bg);
        }

        .queue-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-artist {
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        /* Player Bar */
        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #181818;
            padding: 15px 30px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            gap: 20px;
            border-top: 1px solid #282828;
            z-index: 100;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;
        }

        .now-playing img {
            width: 56px;
            height: 56px;
            border-radius: 4px;
        }

        .now-playing-info {
            flex: 1;
            min-width: 0;
        }

        .now-playing-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }

        .now-playing-artist {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .control-button:hover {
            color: var(--text-primary);
        }

        .play-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .play-button:hover {
            transform: scale(1.1);
        }

        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #4f4f4f;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress {
            width: 0%;
            height: 100%;
            background: var(--text-primary);
            border-radius: 2px;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress-bar:hover .progress {
            background: var(--spotify-green);
        }

        .progress-handle {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .progress-bar:hover .progress-handle {
            display: block;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-end;
        }

        .volume-slider {
            width: 100px;
        }

        /* Playlist Creation Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: #3E3E3E;
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            background: #4F4F4F;
        }

        .btn {
            background: var(--spotify-green);
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .track-card {
            animation: slideUp 0.3s ease forwards;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: var(--spotify-green);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            margin-top: 10px;
            animation: slideUp 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <img src="/api/placeholder/200/60" alt="Spotify Logo" class="login-logo">
        <button class="login-button" onclick="authenticateWithSpotify()">
            Connect with Spotify
        </button>
        <p class="error-message">Premium account required for playback</p>
    </div>

    <!-- Main App -->
    <div class="app-container" id="mainContent" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <img src="/api/placeholder/120/40" alt="Spotify Logo">
            </div>
            <nav>
                <div class="nav-item active">
                    <i class="fas fa-home"></i>
                    Home
                </div>
                <div class="nav-item">
                    <i class="fas fa-search"></i>
                    Search
                </div>
                <div class="nav-item">
                    <i class="fas fa-book"></i>
                    Your Library
                </div>
                <div class="nav-item" onclick="openCreatePlaylistModal()">
                    <i class="fas fa-plus-square"></i>
                    Create Playlist
                </div>
                <div class="nav-item">
                    <i class="fas fa-heart"></i>
                    Liked Songs
                </div>
            </nav>
            <div class="playlists-section" id="userPlaylists">
                <!-- Dynamically populated playlists -->
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search for songs, artists, or playlists" id="searchInput">
                </div>
            </div>
            
            <h2 class="section-title">Your Top Tracks</h2>
            <div class="music-grid" id="topTracks">
                <!-- Dynamically populated tracks -->
            </div>

            <h2 class="section-title">Recently Played</h2>
            <div class="music-grid" id="recentTracks">
                <!-- Dynamically populated tracks -->
            </div>
        </main>

        <!-- Queue Panel -->
        <aside class="queue-panel">
            <div class="queue-header">
                <h3>Play Queue</h3>
                <button class="control-button" onclick="clearQueue()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div id="queueList">
                <!-- Dynamically populated queue -->
            </div>
        </aside>

        <!-- Player Bar -->
        <div class="player-bar">
            <div class="now-playing">
                <img src="/api/placeholder/56/56" alt="Current Track" id="nowPlayingImg">
                <div class="now-playing-info">
                    <div class="now-playing-title" id="nowPlayingTitle">Select a track</div>
                    <div class="now-playing-artist" id="nowPlayingArtist"></div>
                </div>
                <button class="control-button" onclick="toggleLike()">
                    <i class="far fa-heart" id="likeButton"></i>
                </button>
            </div>

            <div class="player-controls">
                <div class="control-buttons">
                    <button class="control-button" onclick="toggleShuffle()">
                        <i class="fas fa-random" id="shuffleButton"></i>
                    </button>
                    <button class="control-button" onclick="previousTrack()">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-button play-button" onclick="togglePlay()">
                        <i class="fas fa-play" id="playButton"></i>
                    </button>
                    <button class="control-button" onclick="nextTrack()">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-button" onclick="toggleRepeat()">
                        <i class="fas fa-redo" id="repeatButton"></i>
                    </button>
                </div>
                <div class="progress-container">
                    <span id="currentTime">0:00</span>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress">
                            <div class="progress-handle"></div>
                        </div>
                    </div>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="volume-control">
                <button class="control-button" onclick="toggleMute()">
                    <i class="fas fa-volume-up" id="volumeIcon"></i>
                </button>
                <div class="progress-bar volume-slider" id="volumeBar">
                    <div class="progress" id="volumeProgress">
                        <div class="progress-handle"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Playlist Modal -->
        <div class="modal" id="playlistModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New Playlist</h3>
                    <button class="modal-close" onclick="closeModal('playlistModal')">Ã—</button>
                </div>
                <form id="createPlaylistForm" onsubmit="createPlaylist(event)">
                    <div class="form-group">
                        <label class="form-label">Playlist Name</label>
                        <input type="text" class="form-input" id="playlistName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-input" id="playlistDescription"></textarea>
                    </div>
                    <button type="submit" class="btn">Create Playlist</button>
                </form>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // Configuration
        const client_id = 'd973e57941cb427b879340c8d93890b1'; // Replace with your Spotify Client ID
        const redirect_uri = window.location.origin + window.location.pathname;
        const scope = 'streaming user-read-email user-read-private user-library-read user-library-modify user-top-reads playlist-modify-public playlist-modify-private user-read-playback-state user-modify-playback-state user-read-recently-played';

        let player;
        let deviceId;
        let currentTrack;
        let queue = [];
        let isShuffled = false;
        let repeatMode = 0; // 0: off, 1: context, 2: track
        let volume = 1;
        let previousVolume = 1;

        // Authentication
        function authenticateWithSpotify() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}`;
            window.location.href = authUrl;
        }

        function getTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        // Initialize Spotify Web Playback SDK
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = getTokenFromUrl();
            if (!token) return;

            player = new Spotify.Player({
                name: 'Ultimate Carpool Player',
                getOAuthToken: cb => { cb(token); }
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                showToast('Player initialization failed: ' + message, 'error');
            });

            player.addListener('authentication_error', ({ message }) => {
                showToast('Authentication failed: ' + message, 'error');
            });

            player.addListener('account_error', ({ message }) => {
                showToast('Premium account required for playback', 'error');
            });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                if (state) {
                    updatePlayerState(state);
                }
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                showToast('Player ready!', 'success');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'grid';
                initializeApp(token, device_id);
            });

            player.connect();
        };

        // Player Control Functions
        async function togglePlay() {
            const button = document.getElementById('playButton');
            if (button.classList.contains('fa-play')) {
                await player.resume();
                button.classList.replace('fa-play', 'fa-pause');
            } else {
                await player.pause();
                button.classList.replace('fa-pause', 'fa-play');
            }
        }

        async function nextTrack() {
            await player.nextTrack();
        }

        async function previousTrack() {
            await player.previousTrack();
        }

        async function seek(position) {
            await player.seek(position);
        }

        async function setVolume(level) {
            volume = level;
            await player.setVolume(level);
            updateVolumeUI(level);
        }

        function toggleMute() {
            if (volume > 0) {
                previousVolume = volume;
                setVolume(0);
            } else {
                setVolume(previousVolume);
            }
        }

        // UI Update Functions
        function updatePlayerState(state) {
            // Update play/pause button
            const playButton = document.getElementById('playButton');
            playButton.classList.replace(
                state.paused ? 'fa-pause' : 'fa-play',
                state.paused ? 'fa-play' : 'fa-pause'
            );

            // Update progress
            if (state.duration) {
                const progress = (state.position / state.duration) * 100;
                document.getElementById('progress').style.width = `${progress}%`;
                updateTimeDisplay(state.position, state.duration);
            }

            // Update track info
            if (state.track_window?.current_track) {
                const track = state.track_window.current_track;
                updateNowPlaying(track);
            }
        }

        function updateTimeDisplay(position, duration) {
            document.getElementById('currentTime').textContent = formatTime(position);
            document.getElementById('duration').textContent = formatTime(duration);
        }

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateNowPlaying(track) {
            document.getElementById('nowPlayingImg').src = track.album.images[0].url;
            document.getElementById('nowPlayingTitle').textContent = track.name;
            document.getElementById('nowPlayingArtist').textContent = track.artists.map(a => a.name).join(', ');
            currentTrack = track;
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize Event Listeners
        function initializeEventListeners() {
            // Progress bar interaction
            const progressBar = document.getElementById('progressBar');
            progressBar.addEventListener('click', e => {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const position = percent * currentTrack.duration_ms;
                seek(position);
            });

            // Volume control interaction
            const volumeBar = document.getElementById('volumeBar');
            volumeBar.addEventListener('click', e => {
                const rect = volumeBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                setVolume(percent);
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', e => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTracks(e.target.value);
                }, 500);
            });
        }

        // API Functions
        async function searchTracks(query) {
            if (!query) {
                loadTopTracks();
                return;
            }

            const response = await fetchSpotifyApi(
                `v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`,
                'GET'
            );
            
            if (response?.tracks?.items) {
                updateMusicGrid(response.tracks.items);
            }
        }

        async function loadTopTracks() {
            const response = await fetchSpotifyApi('v1/me/top/tracks?limit=20', 'GET');
            if (response?.items) {
                updateMusicGrid(response.items);
            }
        }

        async function loadRecentTracks() {
            const response = await fetchSpotifyApi('v1/me/player/recently-played?limit=20', 'GET');
            if (response?.items) {
                updateMusicGrid(response.items.map(item => item.track), 'recentTracks');
            }
        }

        // Playlist Management
        async function createPlaylist(event) {
            event.preventDefault();
            const name = document.getElementById('playlistName').value;
            const description = document.getElementById('playlistDescription').value;

            const user = await fetchSpotifyApi('v1/me', 'GET');
            if (!user?.id) return;

            const response = await fetchSpotifyApi(
                `v1/users/${user.id}/playlists`,
                'POST',
                { name, description, public: true }
            );

            if (response?.id) {
                showToast('Playlist created successfully!', 'success');
                closeModal('playlistModal');
                loadUserPlaylists();
            }
        }

        // Helper Functions
        async function fetchSpotifyApi(endpoint, method, body) {
            try {
                const response = await fetch(`https://api.spotify.com/${endpoint}`, {
                    method,
                    headers: {
                        Authorization: `Bearer ${getTokenFromUrl()}`,
                        'Content-Type': 'application/json',
                    },
                    body: body ? JSON.stringify(body) : undefined
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('An error occurred', 'error');
                return null;
            }
        }

        // Initialize the application
        async function initializeApp(token, deviceId) {
            initializeEventListeners();
            await loadTopTracks();
            await loadRecentTracks();
            await loadUserPlaylists();
        }

        // Start the application
        window.onload = () => {
            const token = getTokenFromUrl();
            if (!token) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }
        };
    </script>
</body>
</html>